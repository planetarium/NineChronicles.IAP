{% extends "base.html" %}

{% block title %}번역어 관리{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">번역어 관리</h1>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Product 번역어 업로드</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="/l10n/upload/product" enctype="multipart/form-data" id="product-form">
                        <div class="mb-3">
                            <label for="product_csv" class="form-label">Product CSV 파일</label>
                            <div class="drop-zone" id="product-drop-zone">
                                <div class="drop-zone-content">
                                    <i class="bi bi-cloud-upload"></i>
                                    <p>파일을 드래그하여 업로드하거나 클릭하여 선택하세요</p>
                                    <input type="file" class="form-control d-none" id="product_csv" name="file" accept=".csv" required>
                                </div>
                            </div>
                            <div id="product-file-name" class="mt-2"></div>
                        </div>
                        <div id="product-preview" class="mb-3 d-none">
                            <h6>미리보기</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead id="product-preview-header"></thead>
                                    <tbody id="product-preview-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="product-submit" disabled>업로드</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Category 번역어 업로드</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="/l10n/upload/category" enctype="multipart/form-data" id="category-form">
                        <div class="mb-3">
                            <label for="category_csv" class="form-label">Category CSV 파일</label>
                            <div class="drop-zone" id="category-drop-zone">
                                <div class="drop-zone-content">
                                    <i class="bi bi-cloud-upload"></i>
                                    <p>파일을 드래그하여 업로드하거나 클릭하여 선택하세요</p>
                                    <input type="file" class="form-control d-none" id="category_csv" name="category_file" accept=".csv" required>
                                </div>
                            </div>
                            <div id="category-file-name" class="mt-2"></div>
                        </div>
                        <div id="category-preview" class="mb-3 d-none">
                            <h6>미리보기</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead id="category-preview-header"></thead>
                                    <tbody id="category-preview-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="category-submit" disabled>업로드</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% if request.session.message %}
    <div class="alert alert-{{ request.session.message_type }} alert-dismissible fade show" role="alert">
        {{ request.session.message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
</div>

<style>
.drop-zone {
    border: 2px dashed #ccc;
    border-radius: 4px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.drop-zone:hover {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}

.drop-zone.dragover {
    border-color: #0d6efd;
    background-color: #e9ecef;
}

.drop-zone-content {
    color: #6c757d;
}

.drop-zone-content i {
    font-size: 2rem;
    margin-bottom: 10px;
}

.drop-zone-content p {
    margin: 0;
}

.table-responsive {
    max-height: 300px;
    overflow-y: auto;
}

.table th {
    position: sticky;
    top: 0;
    background-color: #fff;
    z-index: 1;
}
</style>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">

<script>
async function readCSVFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result;
            const rows = text.split('\n').map(row => row.split(',').map(cell => cell.trim()));
            resolve(rows);
        };
        reader.onerror = reject;
        reader.readAsText(file);
    });
}

function createPreviewTable(rows, headerId, bodyId) {
    if (rows.length < 2) return;

    const header = document.getElementById(headerId);
    const body = document.getElementById(bodyId);

    // 헤더 생성
    header.innerHTML = '<tr>' + rows[0].map(cell => `<th>${cell}</th>`).join('') + '</tr>';

    // 본문 생성 (최대 5행만 표시)
    body.innerHTML = rows.slice(1, 6).map(row =>
        '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>'
    ).join('');

    // 5행 이상인 경우 메시지 추가
    if (rows.length > 6) {
        body.innerHTML += `<tr><td colspan="${rows[0].length}" class="text-center">... ${rows.length - 6} 행 더 있음</td></tr>`;
    }
}

function setupDropZone(dropZoneId, fileInputId, fileNameId, submitButtonId, previewId, headerId, bodyId) {
    const dropZone = document.getElementById(dropZoneId);
    const fileInput = document.getElementById(fileInputId);
    const fileNameDisplay = document.getElementById(fileNameId);
    const submitButton = document.getElementById(submitButtonId);
    const preview = document.getElementById(previewId);

    // 클릭으로 파일 선택
    dropZone.addEventListener('click', () => fileInput.click());

    // 드래그 이벤트 처리
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            await updateFile(files[0]);
        }
    });

    // 파일 선택 시 처리
    fileInput.addEventListener('change', async (e) => {
        if (e.target.files.length > 0) {
            await updateFile(e.target.files[0]);
        }
    });

    async function updateFile(file) {
        fileNameDisplay.textContent = `선택된 파일: ${file.name}`;
        try {
            const rows = await readCSVFile(file);
            createPreviewTable(rows, headerId, bodyId);
            preview.classList.remove('d-none');
            submitButton.disabled = false;
        } catch (error) {
            alert('파일을 읽는 중 오류가 발생했습니다.');
            fileNameDisplay.textContent = '';
            preview.classList.add('d-none');
            submitButton.disabled = true;
        }
    }
}

// Product와 Category 드롭존 설정
setupDropZone(
    'product-drop-zone',
    'product_csv',
    'product-file-name',
    'product-submit',
    'product-preview',
    'product-preview-header',
    'product-preview-body'
);

setupDropZone(
    'category-drop-zone',
    'category_csv',
    'category-file-name',
    'category-submit',
    'category-preview',
    'category-preview-header',
    'category-preview-body'
);
</script>
{% endblock %}